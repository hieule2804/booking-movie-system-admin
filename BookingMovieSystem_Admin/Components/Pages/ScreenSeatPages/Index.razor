@page "/screenseats"
@using Microsoft.EntityFrameworkCore
@using BookingMovieSystem_Admin.Models
@implements IAsyncDisposable
@inject IDbContextFactory<G5MovieTicketBookingSystemContext> DbFactory

<PageTitle>Screen Seats</PageTitle>

<div class="container mt-4">
    <h1 class="text-primary text-center">Screen Seats</h1>

    <p class="text-end">
        <a href="screenseats/create" class="btn btn-success">Create New</a>
    </p>

    <!-- Tìm kiếm -->
    <div class="mb-3">
        <input class="form-control" style="max-width:600px" placeholder="Tìm kiếm ..." @bind="searchItem" />
        <button class="btn btn-primary mt-2" style="max-width:300px" @onclick="OnSearchClicked">
            Tìm kiếm
        </button>
    </div>

    <!-- Bảng hiển thị các ghế màn hình -->
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead>
                <tr>
                    <th>Seat Label</th>
                    <th>Seat Type</th>
                    <th>Base Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var screenseat in ScreenSeats)
                {
                    <tr>
                        <td>@screenseat.SeatLabel</td>
                        <td>@screenseat.SeatType.SeatTypeName</td>
                        <td>@screenseat.SeatType.BasePrice</td>
                        <td>
                            <div class="d-flex justify-content-center gap-2">
                                <a href="@($"screenseats/edit?screenseatid={screenseat.ScreenSeatId}")" class="btn btn-warning btn-sm">Edit</a>
                                <a href="@($"screenseats/details?screenseatid={screenseat.ScreenSeatId}")" class="btn btn-info btn-sm">Details</a>
                                <a href="@($"screenseats/delete?screenseatid={screenseat.ScreenSeatId}")" class="btn btn-danger btn-sm">Delete</a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Phân trang -->
    <div class="text-center mt-3">
        <button class="btn btn-secondary" @onclick="GoToPreviousPage" disabled="@IsFirstPage">Trước</button>
        <span>Trang @currentPage của @totalPages</span>
        <button class="btn btn-secondary" @onclick="GoToNextPage" disabled="@IsLastPage">Sau</button>
    </div>
</div>

@code {
    private G5MovieTicketBookingSystemContext context = default!;
    private List<ScreenSeat> ScreenSeats = new();
    private string searchItem = string.Empty;  // Từ khóa tìm kiếm
    private int currentPage = 1;  // Trang hiện tại
    private int pageSize = 5;  // Số lượng màn hình trên mỗi trang
    private int totalPages = 1; // Tổng số trang
    private int totalSeats = 0; // Tổng số ghế màn hình

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        await LoadScreenSeats();
    }

    private async Task LoadScreenSeats()
    {
        // Truy vấn cơ sở dữ liệu
        var query = context.ScreenSeats
            .Include(s => s.SeatType)
            .AsNoTracking();

        // Lọc theo từ khóa tìm kiếm
        if (!string.IsNullOrEmpty(searchItem))
        {
            query = query.Where(s => s.SeatLabel.Contains(searchItem, StringComparison.OrdinalIgnoreCase));
        }

        // Tính tổng số ghế
        totalSeats = await query.CountAsync();

        // Tính số trang
        totalPages = (int)Math.Ceiling(totalSeats / (double)pageSize);

        // Lấy dữ liệu cho trang hiện tại
        ScreenSeats = await query
            .Skip((currentPage - 1) * pageSize)  // Bỏ qua các bản ghi trước đó
            .Take(pageSize)  // Lấy số lượng bản ghi cho trang hiện tại
            .ToListAsync();
    }

    // Xử lý sự kiện khi nhấn nút "Tìm kiếm"
    private async Task OnSearchClicked()
    {
        await LoadScreenSeats(); 
    }

    // Chuyển đến trang trước
    private async Task GoToPreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadScreenSeats();
        }
    }

    // Chuyển đến trang sau
    private async Task GoToNextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadScreenSeats();
        }
    }

    // Kiểm tra nếu đang ở trang đầu tiên
    private bool IsFirstPage => currentPage == 1;

    // Kiểm tra nếu đang ở trang cuối cùng
    private bool IsLastPage => currentPage == totalPages;

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>
    // Kết nối đến SignalR Hub
    var connection = new signalR.HubConnectionBuilder()
        .withUrl("/screenseatHub")
        .build();

    // Bắt đầu kết nối SignalR
    connection.start().catch(function (err) {
        console.error("❌ SignalR Connection Error:", err.toString());
    });

    // Lắng nghe sự kiện cập nhật
    connection.on("ReceiveUpdateNotification", function (screenseat) {
        location.reload();
    });

    connection.on("ReceiveAddNotification", function (screenseat) {
        location.reload();
    });

    connection.on("ReceiveDeleteNotification", function (screenseat) {
        location.reload();
    });
</script>
